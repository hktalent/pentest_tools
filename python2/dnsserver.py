#-*- coding:utf-8 -*-
import dns.resolver
import dns.query
import socket
import sys
import dns.message

# def resolve_dns(host, record_type='A'):
# 	try:
# 		answers = dns.resolver.query(host, record_type)
# 		return answers[0]
# 	except Exception, e:
# 		print e
# 		return 0

def dnsserver():
	sock_udp = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
	print 'starting dns server on udp port 53 with 0.0.0.0'
	sock_udp.bind(("0.0.0.0", 53))
	try:
		while True:
			print >>sys.stderr, '\nwaiting to receive message'
			data, address = sock_udp.recvfrom(4096)
			print >>sys.stderr, 'received %s bytes from %s' % (len(data), address)
			# print data.encode('utf-8')
			wire = dns.message.from_wire(data)
			response = dns.query.udp(wire, '8.8.8.8')
			sock_udp.sendto(response.to_wire(), address)
	except Exception,e:
		print e

dnsserver()




