# -*- coding: utf-8 -*-
import xlrd
import os
import optparse

def main():
	parser = optparse.OptionParser("usage python match_url_excel " + "--excelfile <file1>,<file2>,file3,... -s urlfile")
	parser.add_option('--excelfile', dest='filelist', type='string', help='specify excel file list')
	parser.add_option('-s', dest='urlfile', type='string', help='specify url file')
	(options, args) = parser.parse_args()
	excelfilelist = str(options.filelist).replace(" ","").split(',')
	urlfile = options.urlfile
	if ((excelfilelist[0] == None) or (urlfile == None )):
		print '[-] You must specify a list of excel file and a url source file'
		exit(0)
	
	# print excelfilelist
	# print urlfile
	print "[!]Checking if all files are ready..."
	for filepath in excelfilelist:
		checkfileifvalid(filepath)
	checkfileifvalid(urlfile)
	
	print "Everything is good!!! start processing"
	finditembyurl(excelfilelist[0], urlfile)
def checkfileifvalid(filepath):
	if not os.path.isfile(filepath):
		print '[-] ' + filepath + ' does not exist.'
		exit(0)
	if not os.access(filepath, os.R_OK):
		print '[-] ' + filepath + ' access denied'
		exit(0)
	
	

def finditembyurl(excelfile, urlfile):
	book = xlrd.open_workbook(excelfile)
	print(u"Worksheet name(s): {0}".format(book.sheet_names()))
	sh = book.sheet_by_index(0)
	# print(u"{0} {1} {2}".format(sh.name, sh.nrows, sh.ncols))
	temp_department = ''
	dep_column = 0
	url_column = 0
	temp_row = 0
	for row in range(0,sh.nrows):
		# print sh.row(row)
		for col in range(0,len(sh.row(row))):
			if (u'事业部' == sh.cell_value(row,col)) or (u'部门' == sh.cell_value(row,col)):
				dep_column = col
				temp_row = row
			elif (sh.cell_value(row,col) in [u'巡检网址', u'正式url', u'访问url']):
				url_column = col
				if (row == temp_row):
					break;
				else:
					exit(0)
	# print dep_column
	# print temp_row
	# print url_column
	with open(urlfile) as f:
		for line in f:
			# print line
			for row in range(temp_row + 1,sh.nrows):
		# print sh.row(row)
				if sh.cell_value(row,dep_column):
					temp_department = sh.cell_value(row,dep_column)
					# print temp_department
				if line.lower().strip() in sh.cell_value(row,url_column):
					sh._cell_types[row][dep_column] = xlrd.XL_CELL_TEXT
					sh._cell_values[row][dep_column] = unicode(temp_department)
					# print sh.row(row)[dep_column].value
					temp = u''
					for cell in sh.row(row):
						if cell.ctype == xlrd.XL_CELL_NUMBER:
							temp = temp + str(cell.value).decode("utf-8") + u' ,'
						if cell.ctype == xlrd.XL_CELL_TEXT:
							temp = temp + cell.value + u' ,'
					print temp
						
					#if line in sh.cell_value(row,col)
						
			
				

if __name__=='__main__':
	main()